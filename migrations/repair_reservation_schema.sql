-- REPAIR SCRIPT FOR RESERVATION SCHEMA (CORRECTED)
-- Fixes FOREIGN KEYS and missing columns.

-- 1. Ensure 'zones' has the correct columns
CREATE TABLE IF NOT EXISTS zones (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now(),
  name TEXT, 
  name_es TEXT,
  name_en TEXT,
  "position" INTEGER DEFAULT 0,
  restaurant_id UUID REFERENCES restaurants(id)
);

DO $$
BEGIN
    ALTER TABLE zones ADD COLUMN IF NOT EXISTS name_es TEXT;
    ALTER TABLE zones ADD COLUMN IF NOT EXISTS name_en TEXT;
    ALTER TABLE zones ADD COLUMN IF NOT EXISTS restaurant_id UUID REFERENCES restaurants(id);
END $$;

-- 2. Ensure 'tables' has the correct columns
CREATE TABLE IF NOT EXISTS tables (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  created_at TIMESTAMPTZ DEFAULT now(),
  table_number TEXT,
  zone_id BIGINT REFERENCES zones(id),
  min_pax INTEGER,
  max_pax INTEGER,
  restaurant_id UUID REFERENCES restaurants(id)
);

DO $$
BEGIN
    ALTER TABLE tables ADD COLUMN IF NOT EXISTS restaurant_id UUID REFERENCES restaurants(id);
END $$;

-- 3. FIX DELETION ISSUES (Cascade Delete)

-- For Tables -> Zones
DO $$
BEGIN
  -- Drop constraint if exists (try standard names)
  BEGIN
    ALTER TABLE tables DROP CONSTRAINT IF EXISTS tables_zone_id_fkey;
  END;
  
  -- Re-add with CASCADE
  ALTER TABLE tables 
    ADD CONSTRAINT tables_zone_id_fkey 
    FOREIGN KEY (zone_id) 
    REFERENCES zones(id) 
    ON DELETE CASCADE;
END $$;

-- For Bookings -> Tables (Set Null)
-- NOTE: Correct column name is 'assigned_table_id'
DO $$
BEGIN
  BEGIN
    ALTER TABLE bookings DROP CONSTRAINT IF EXISTS bookings_assigned_table_id_fkey;
  END;

  -- Only add constraint if the column exists
  IF EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name = 'bookings' AND column_name = 'assigned_table_id') THEN
      ALTER TABLE bookings 
        ADD CONSTRAINT bookings_assigned_table_id_fkey 
        FOREIGN KEY (assigned_table_id) 
        REFERENCES tables(id) 
        ON DELETE SET NULL;
  END IF;
END $$;

-- 4. Enable RLS
ALTER TABLE zones ENABLE ROW LEVEL SECURITY;
ALTER TABLE tables ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Enable all zones" ON zones USING (true);
CREATE POLICY "Enable all tables" ON tables USING (true);
